<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typer CS2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<style>
:root {
    --primary: #4f46e5;
    --secondary: #10b981;
    --bg: #f9fafb;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --danger: #ef4444;
}
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
body { background: var(--bg); color: var(--text); min-height:100vh; display:flex; flex-direction:column;}
header { background: var(--primary); color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center;}
header h1 { font-size:1.5rem;}
header button { background:white;color:var(--primary);border:none;padding:0.5rem 1rem;border-radius:6px;cursor:pointer; transition:0.3s;}
header button:hover { background:#e0e7ff; }
nav { display:flex; justify-content:center; background:#e5e7eb; padding:0.5rem 0;}
nav button { background:transparent; border:none; margin:0 1rem; padding:0.5rem 1rem; font-weight:600; cursor:pointer; transition:0.3s;}
nav button.active, nav button:hover { border-bottom:3px solid var(--primary); color:var(--primary);}
main { flex:1; padding:2rem;}
.tab-content { display:none; animation: fadeIn 0.5s ease;}
.tab-content.active { display:block;}
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

.match-card { background: var(--card); padding:1rem; margin-bottom:1rem; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; transition:0.3s;}
.match-card:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.match-info { display:flex; flex-direction:column;}
.match-teams { font-weight:600; font-size:1.1rem;}
.match-time { font-size:0.9rem; color:var(--muted);}
.btn { padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; transition:0.3s; font-weight:600;}
.btn-submit { background: var(--primary); color:white;}
.btn-submit:hover { background:#4338ca;}
.btn-danger { background: var(--danger); color:white;}
.btn-danger:hover { background:#b91c1c;}
.input-score { width:50px; padding:0.3rem; border-radius:4px; border:1px solid #d1d5db; margin:0 0.3rem;}
.notification { position:fixed; top:1rem; right:1rem; padding:1rem 1.5rem; border-radius:6px; color:white; font-weight:600; display:none; opacity:0; transition:0.3s;}
.notification.show { display:block; opacity:1;}
.notification.success { background: var(--secondary);}
.notification.error { background: var(--danger);}
.ranking-table { width:100%; border-collapse:collapse; margin-top:1rem;}
.ranking-table th, .ranking-table td { padding:0.8rem; text-align:left; border-bottom:1px solid #e5e7eb;}
.ranking-table th { background:#f3f4f6;}
.admin-section { margin-bottom:2rem;}
.admin-section h3 { margin-bottom:1rem;}
.admin-section input, .admin-section select { padding:0.5rem; margin-right:0.5rem; border-radius:6px; border:1px solid #d1d5db;}
.admin-section button { margin-top:0.5rem;}
.filter-day { margin-bottom:1rem; }
.history-list { margin-top:0.5rem; }
</style>
</head>
<body>
<header>
<h1>Typer CS2</h1>
<div>
    <span id="user-name">Zaloguj</span>
    <button id="logoutBtn" style="display:none;">Wyloguj</button>
</div>
</header>

<nav>
<button class="tab-btn active" data-tab="typowanie">Typowanie</button>
<button class="tab-btn" data-tab="ranking">Ranking</button>
<button class="tab-btn" data-tab="admin">Panel Admina</button>
</nav>

<main>
<section id="typowanie" class="tab-content active">
<h2>Mecze do typowania</h2>
<div class="filter-day">
    <label>Filtruj po dniu: <input type="date" id="filterDate"></label>
</div>
<div id="matches-list"></div>
<h3>Historia Twoich typ√≥w</h3>
<div id="user-history" class="history-list"></div>
</section>

<section id="ranking" class="tab-content">
<h2>Ranking</h2>
<table class="ranking-table">
<thead>
<tr><th>#</th><th>Nick</th><th>Punkty</th></tr>
</thead>
<tbody id="ranking-list"></tbody>
</table>
</section>

<section id="admin" class="tab-content">
<div class="admin-section">
<h3>Dodaj mecz</h3>
<input type="text" id="teamA" placeholder="Team A">
<input type="text" id="teamB" placeholder="Team B">
<input type="date" id="matchDate">
<input type="time" id="matchTime">
<input type="number" id="bop" placeholder="BOP" min="1" max="7">
<button class="btn btn-submit" id="addMatchBtn">Dodaj</button>
</div>
<div class="admin-section">
<h3>Mecze</h3>
<div id="admin-matches-list"></div>
</div>
<div class="admin-section">
<h3>U≈ºytkownicy</h3>
<div id="admin-users-list"></div>
</div>
</section>
</main>

<div id="notification" class="notification"></div>

<script>
// -------------------- FIREBASE CONFIG --------------------
const firebaseConfig = {
  apiKey: "AIzaSyDwh9_u2u_NenhPYyvhCaLKFCrCrMmMEGE",
  authDomain: "cs2typer.firebaseapp.com",
  projectId: "cs2typer",
  storageBucket: "cs2typer.firebasestorage.app",
  messagingSenderId: "533657649328",
  appId: "1:533657649328:web:e220acd6865b489fa6bb75"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser=null, isAdmin=false;
const adminEmails=["paweloxbieniek1@gmail.com"];
let matches=[], users=[], rankings={};

// -------------------- AUTH --------------------
const loginBtn=document.getElementById("user-name");
const logoutBtn=document.getElementById("logoutBtn");

loginBtn.addEventListener("click",()=>{ const provider=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); });
logoutBtn.addEventListener("click",()=>auth.signOut());

auth.onAuthStateChanged(user=>{
    if(user){
        currentUser=user;
        loginBtn.style.display="none"; logoutBtn.style.display="inline-block";
        document.getElementById("user-name").textContent=`Zalogowany jako: ${user.displayName}`;
        checkAdmin(user.email);
        loadData();
    } else {
        currentUser=null;
        loginBtn.style.display="inline-block"; logoutBtn.style.display="none";
        document.getElementById("user-name").textContent="Zaloguj";
        document.getElementById("matches-list").innerHTML="";
        document.getElementById("ranking-list").innerHTML="";
        document.getElementById("admin-matches-list").innerHTML="";
        document.getElementById("admin-users-list").innerHTML="";
        document.getElementById("user-history").innerHTML="";
    }
});

function checkAdmin(email){
    isAdmin=adminEmails.includes(email);
    const adminTab=document.querySelector('nav button[data-tab="admin"]');
    adminTab.style.display=isAdmin?"inline-block":"none";
}

// -------------------- TABS --------------------
const tabs=document.querySelectorAll('.tab-btn');
const contents=document.querySelectorAll('.tab-content');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    const tabId=tab.getAttribute('data-tab');
    contents.forEach(c=>c.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
}));

function showNotification(msg,type="success"){
    const notif=document.getElementById("notification");
    notif.textContent=msg; notif.className=`notification ${type} show`;
    setTimeout(()=>{ notif.className=`notification ${type}`; },2000);
}

// -------------------- LOAD DATA --------------------
function loadData(){
    db.collection("matches").orderBy("startTime").get().then(snap=>{
        matches=snap.docs.map(doc=>({id:doc.id, ...doc.data()}));
        renderMatches();
        renderAdminMatches();
    });
    db.collection("users").get().then(snap=>{
        users=snap.docs.map(doc=>({id:doc.id, ...doc.data()}));
        buildRanking();
        renderAdminUsers();
        renderUserHistory();
    });
}

// -------------------- RENDER MATCHES --------------------
function renderMatches(){
    const container=document.getElementById("matches-list");
    container.innerHTML="";
    const filter=document.getElementById("filterDate").value;
    const now=new Date();
    matches.forEach(match=>{
        const start=match.startTime.toDate?match.startTime.toDate():new Date(match.startTime);
        if(filter && filter!==start.toISOString().slice(0,10)) return;
        const canType=now<start;
        const div=document.createElement("div");
        div.className="match-card";
        div.innerHTML=`
            <div class="match-info">
                <span class="match-teams">${match.teamA} vs ${match.teamB}</span>
                <span class="match-time">${start.toLocaleString()} | BOP: ${match.bop}</span>
            </div>
            <div class="match-actions">
                <input type="number" min="0" placeholder="Wynik ${match.teamA}" id="scoreA_${match.id}" class="input-score" ${!canType?"disabled":""}>
                <input type="number" min="0" placeholder="Wynik ${match.teamB}" id="scoreB_${match.id}" class="input-score" ${!canType?"disabled":""}>
                <button class="btn btn-submit" onclick="submitType('${match.id}')" ${!canType?"disabled":""}>Wy≈õlij</button>
            </div>
            <div class="type-feedback" id="feedback_${match.id}"></div>
        `;
        container.appendChild(div);
        if(canType) startCountdown(match.id,start);
    });
}
document.getElementById("filterDate").addEventListener("change",renderMatches);

// -------------------- COUNTDOWN --------------------
function startCountdown(matchId,startTime){
    const interval=setInterval(()=>{
        const now=new Date();
        const diff=startTime-now;
        const feedback=document.getElementById(`feedback_${matchId}`);
        if(diff<=0){ feedback.textContent="‚è±Ô∏è Mecz rozpoczƒôty!"; clearInterval(interval); renderMatches(); }
        else{
            const minutes=Math.floor(diff/60000);
            const seconds=Math.floor((diff%60000)/1000);
            feedback.textContent=`Pozosta≈Ço: ${minutes}:${seconds<10?"0"+seconds:seconds}`;
        }
    },1000);
}

// -------------------- SUBMIT TYPE --------------------
function submitType(matchId){
    const scoreA=parseInt(document.getElementById(`scoreA_${matchId}`).value);
    const scoreB=parseInt(document.getElementById(`scoreB_${matchId}`).value);
    if(isNaN(scoreA)||isNaN(scoreB)) return showNotification("Podaj poprawne wyniki!","error");
    db.collection("matches").doc(matchId).collection("types").doc(currentUser.uid).set({
        userId: currentUser.uid, nick: currentUser.displayName, scoreA, scoreB, timestamp:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{ showNotification("üü¢ Typ oddany!","success"); buildRanking(); renderUserHistory(); });
}

// -------------------- RANKING --------------------
function buildRanking(){
    rankings={};
    users.forEach(u=>{ rankings[u.id]=u.points||0; });
    // Dodaj punkty z typ√≥w
    matches.forEach(match=>{
        match.types&&Object.entries(match.types).forEach(([uid,data])=>{
            if(rankings[uid]===undefined) rankings[uid]=0;
            const exact=(data.scoreA===match.scoreA && data.scoreB===match.scoreB)?2:0;
            const winner=((data.scoreA>data.scoreB && match.scoreA>match.scoreB) || (data.scoreA< data.scoreB && match.scoreA< match.scoreB))?1:0;
            rankings[uid]+=exact+winner;
        });
    });
    renderRanking();
}
function renderRanking(){
    const tbody=document.getElementById("ranking-list");
    tbody.innerHTML="";
    const sorted=Object.entries(rankings).sort((a,b)=>b[1]-a[1]);
    sorted.forEach(([uid,points],index)=>{
        const user=users.find(u=>u.id===uid);
        if(!user) return;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${index+1}</td><td>${user.nick}</td><td>${points}</td>`;
        tbody.appendChild(tr);
    });
}

// -------------------- USER HISTORY --------------------
function renderUserHistory(){
    const container=document.getElementById("user-history");
    container.innerHTML="";
    matches.forEach(match=>{
        const type=match.types && match.types[currentUser.uid];
        if(type){
            const div=document.createElement("div");
            div.textContent=`${match.teamA} ${type.scoreA} - ${type.scoreB} ${match.teamB} | ${new Date(match.startTime.toDate?match.startTime.toDate():match.startTime).toLocaleString()}`;
            container.appendChild(div);
        }
    });
}

// -------------------- ADMIN --------------------
document.getElementById("addMatchBtn").addEventListener("click",()=>{
    const teamA=document.getElementById("teamA").value;
    const teamB=document.getElementById("teamB").value;
    const bop=parseInt(document.getElementById("bop").value);
    const date=document.getElementById("matchDate").value;
    const time=document.getElementById("matchTime").value;
    if(!teamA||!teamB||!bop||!date||!time) return showNotification("Uzupe≈Çnij wszystkie pola!","error");
    const [h,m]=time.split(":"); const startTime=new Date(date); startTime.setHours(h); startTime.setMinutes(m);
    db.collection("matches").add({teamA,teamB,bop,startTime}).then(()=>{ showNotification("Mecz dodany!","success"); loadData(); });
});

function renderAdminMatches(){
    const container=document.getElementById("admin-matches-list"); container.innerHTML="";
    matches.forEach(match=>{
        const div=document.createElement("div");
        div.className="match-card";
        div.innerHTML=`${match.teamA} vs ${match.teamB} | ${new Date(match.startTime.toDate?match.startTime.toDate():match.startTime).toLocaleString()}
        <button class="btn btn-danger" onclick="deleteMatch('${match.id}')">Usu≈Ñ</button>`;
        container.appendChild(div);
    });
}
function renderAdminUsers(){
    const container=document.getElementById("admin-users-list"); container.innerHTML="";
    users.forEach(u=>{
        const div=document.createElement("div");
        div.className="match-card";
        div.innerHTML=`${u.nick} (${u.email||u.id}) <button class="btn btn-danger" onclick="deleteUser('${u.id}')">Usu≈Ñ</button>`;
        container.appendChild(div);
    });
}
function deleteMatch(id){ if(confirm("Na pewno chcesz usunƒÖƒá mecz?")){ db.collection("matches").doc(id).delete().then(()=>loadData()); }}
function deleteUser(id){ if(confirm("Na pewno chcesz usunƒÖƒá u≈ºytkownika?")){ db.collection("users").doc(id).delete().then(()=>loadData()); }}
</script>
</body>
</html>
